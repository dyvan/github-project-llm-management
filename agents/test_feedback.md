# Test Feedback Agent

## ðŸ“‹ RÃ´le

Le **Test Feedback Agent** est un agent autonome qui lit les rÃ©sultats de CI/CD (tests, lint, build), analyse les erreurs, et met Ã  jour automatiquement le GitHub Project Board. Il fournit un retour clair au dÃ©veloppeur et synchronise l'Ã©tat du projet.

## ðŸŽ¯ Objectif

- ExÃ©cuter lint, tests, et build automatiquement
- Capturer et rapporter les erreurs de maniÃ¨re lisible
- Mettre Ã  jour le statut du Project Board (In QA â†’ Done / Blocked)
- AccÃ©lÃ©rer le feedback au dÃ©veloppeur

## ðŸ”„ Flux d'exÃ©cution

### 1. **DÃ©clenchement**

```yaml
on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
```

**Contextes** :
- Push sur branche de dÃ©veloppement
- PR ouverte/synchronisÃ©e

### 2. **Actions**

#### Ã‰tape 1 : Setup de l'environnement
```yaml
- Set up Python 3.11
- Install dependencies from requirements.txt
- Install dev tools: pytest, black, pylint, mypy
```

#### Ã‰tape 2 : VÃ©rifications de qualitÃ©

**A. Format Check (Black)**
```bash
black --check --line-length 100 src/ tests/
```
- VÃ©rifie que le code respecte le style Black
- Erreur non-bloquant (continue-on-error)

**B. Lint (Pylint)**
```bash
pylint src/ --disable=C0111,W0212 --fail-under=7.0
```
- VÃ©rifie la qualitÃ© du code
- Fail si score < 7.0
- Erreur non-bloquant

**C. Type Checking (Mypy)**
```bash
mypy src/ --ignore-missing-imports
```
- VÃ©rifications de type statique
- Erreur non-bloquant

#### Ã‰tape 3 : Tests unitaires
```bash
pytest tests/ \
  --cov=src/ \
  --cov-report=xml \
  --cov-report=html \
  --junitxml=test-results.xml
```

**Sorties** :
- Coverage report XML
- HTML report gÃ©nÃ©rÃ©
- JUnit XML pour CI integration

#### Ã‰tape 4 : Build (si applicable)
```bash
python -m build
```

CrÃ©e distributions (wheel, sdist) si applicable

#### Ã‰tape 5 : Rapport et commentaire PR
Poste un commentaire sur la PR avec :
- âœ… Tests passÃ©s ou âŒ Tests Ã©chouÃ©s
- ðŸ“Š Coverage percentage
- ðŸ“ DÃ©tails des erreurs

**Exemple de commentaire** :

```markdown
## âœ… Tests Passed

- All unit tests passed: 127/127 âœ…
- Coverage: 85%

**Test Results**:
- test_authentication.py: 45 tests âœ…
- test_database.py: 52 tests âœ…
- test_api.py: 30 tests âœ…

---
*Generated by GitHub Actions*
```

#### Ã‰tape 6 : Mise Ã  jour du statut de commit
```bash
github.rest.repos.createCommitStatus({
  state: 'success',
  description: 'All checks passed!',
  context: 'ci/tests'
})
```

### 3. **RÃ©sultat attendu**

#### Cas d'exÃ©cution rÃ©ussie
```
âœ… All checks passed!
- Format: OK (black)
- Lint: OK (pylint score: 9.2)
- Tests: 127/127 passed
- Coverage: 85%
- Build: âœ…

Status â†’ "Ready for Merge"
```

#### Cas d'Ã©chec
```
âŒ Some checks failed

**Failing tests**:
- test_api.py::test_login FAILED (line 45)
  AssertionError: expected True, got False
- test_database.py::test_connection FAILED
  ConnectionError: cannot connect to localhost:5432

**Lint issues**:
- src/auth.py:12: Line too long (105 > 100)
- src/auth.py:23: Missing docstring

Status â†’ "Blocked"
```

## ðŸ” Permissions requises

| Permission | Raison |
|-----------|--------|
| `contents: read` | Lire le code |
| `pull-requests: write` | Commenter sur PRs |
| `statuses: write` | Ã‰crire les commit status |

## âš™ï¸ Configuration

### Fichier de workflow
`.github/workflows/ci-tests.yml`

### DÃ©pendances Python
```
pytest
pytest-cov
black
pylint
mypy
```

### Matrice de tests
```yaml
python-version: ["3.11"]
```

Peut Ãªtre Ã©tendu Ã  plusieurs versions (3.9, 3.10, 3.11, 3.12)

## ðŸ“Š MÃ©triques capturÃ©es

| MÃ©trique | Source | Utilisation |
|----------|--------|-------------|
| **Test Count** | JUnit XML | Tracking du progrÃ¨s |
| **Pass/Fail Ratio** | pytest | QualitÃ© globale |
| **Coverage %** | coverage.xml | Couverture de code |
| **Lint Score** | pylint | QualitÃ© du code |
| **Build Status** | Build output | CompilabilitÃ© |

## ðŸ”„ IntÃ©gration avec GitHub Project

Mapping des statuts :

| Test Status | Project Status |
|------------|----------------|
| âœ… Tous les tests passent | â†’ "Ready for Merge" |
| âŒ Tests Ã©chouent | â†’ "Blocked" |
| â³ Tests en cours | â†’ "In QA" |

**Exemple GraphQL** (futur) :
```graphql
mutation UpdateProjectStatus {
  updateProjectV2ItemFieldValue(input: {
    projectId: "abc123"
    itemId: "def456"
    fieldId: "status"
    value: "Ready for Merge"
  }) {
    projectV2Item {
      id
    }
  }
}
```

## ðŸ’¡ Cas d'usage

### Quand c'est utile
- âœ… Validation rapide avant review humain
- âœ… Feedback immÃ©diat au dÃ©veloppeur
- âœ… Tracking de coverage tendance
- âœ… Blocage automatique de PRs cassÃ©es

### Quand ce n'est pas suffisant
- âŒ Bugs complexes â†’ tests manuels requis
- âŒ Tests d'intÃ©gration â†’ infrastructure requise
- âŒ Tests e2e â†’ setup Selenium/Playwright requis

## ðŸš¨ Gestion des erreurs

### Erreur : "Module not found"
```
ImportError: No module named 'myapp'
```
**Solution** : VÃ©rifier `requirements.txt` et l'import paths

### Erreur : "Database connection failed"
```
ConnectionError: cannot connect to localhost:5432
```
**Solution** : Utiliser un mock/in-memory DB pour CI (sqlite, h2)

### Erreur : "Coverage below threshold"
```
CoverageWarning: Coverage below 80%
```
**Solution** : Ajouter des tests ou baisser le threshold

## ðŸ“ˆ Ã‰volution des mÃ©triques

Tracking dans le temps :

```bash
# Voir l'historique de coverage
git log --oneline | xargs -I {} sh -c 'git show {}:coverage.xml | grep coverage'

# Voir les trends de tests
gh run list --workflow ci-tests.yml
```

## ðŸ”® AmÃ©liorations futures

- [ ] Rapport dÃ©taillÃ© de coverage par fichier
- [ ] DÃ©tection de regressions (score baisse)
- [ ] IntÃ©gration avec CodeCov pour tracking visuel
- [ ] Support de multiples langages (JS, Go, etc.)
- [ ] Fail sur security issues (bandit pour Python)
- [ ] Notification Slack/Discord sur failure
- [ ] Cache des dÃ©pendances pour faster runs
- [ ] Parallel test execution

## ðŸ“‹ Checklist pour les mainteneurs

Avant de dÃ©ployer :

- [ ] Tests locaux passent : `pytest tests/`
- [ ] Lint OK : `black --check . && pylint src/`
- [ ] Coverage > 80% : `pytest --cov=src/`
- [ ] Workflow YAML valide : `yamllint .github/workflows/`
- [ ] Tester sur une PR pilote
- [ ] Configurer les alertes (email, Slack)

## ðŸ“š Ressources

- [Pytest Documentation](https://docs.pytest.org/)
- [Black Code Formatter](https://black.readthedocs.io/)
- [Pylint Documentation](https://pylint.pycqa.org/)
- [MyPy Documentation](https://mypy.readthedocs.io/)
