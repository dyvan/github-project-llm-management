# Test Feedback Agent

## 📋 Rôle

Le **Test Feedback Agent** est un agent autonome qui lit les résultats de CI/CD (tests, lint, build), analyse les erreurs, et met à jour automatiquement le GitHub Project Board. Il fournit un retour clair au développeur et synchronise l'état du projet.

## 🎯 Objectif

- Exécuter lint, tests, et build automatiquement
- Capturer et rapporter les erreurs de manière lisible
- Mettre à jour le statut du Project Board (In QA → Done / Blocked)
- Accélérer le feedback au développeur

## 🔄 Flux d'exécution

### 1. **Déclenchement**

```yaml
on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
```

**Contextes** :
- Push sur branche de développement
- PR ouverte/synchronisée

### 2. **Actions**

#### Étape 1 : Setup de l'environnement
```yaml
- Set up Python 3.11
- Install dependencies from requirements.txt
- Install dev tools: pytest, black, pylint, mypy
```

#### Étape 2 : Vérifications de qualité

**A. Format Check (Black)**
```bash
black --check --line-length 100 src/ tests/
```
- Vérifie que le code respecte le style Black
- Erreur non-bloquant (continue-on-error)

**B. Lint (Pylint)**
```bash
pylint src/ --disable=C0111,W0212 --fail-under=7.0
```
- Vérifie la qualité du code
- Fail si score < 7.0
- Erreur non-bloquant

**C. Type Checking (Mypy)**
```bash
mypy src/ --ignore-missing-imports
```
- Vérifications de type statique
- Erreur non-bloquant

#### Étape 3 : Tests unitaires
```bash
pytest tests/ \
  --cov=src/ \
  --cov-report=xml \
  --cov-report=html \
  --junitxml=test-results.xml
```

**Sorties** :
- Coverage report XML
- HTML report généré
- JUnit XML pour CI integration

#### Étape 4 : Build (si applicable)
```bash
python -m build
```

Crée distributions (wheel, sdist) si applicable

#### Étape 5 : Rapport et commentaire PR
Poste un commentaire sur la PR avec :
- ✅ Tests passés ou ❌ Tests échoués
- 📊 Coverage percentage
- 📝 Détails des erreurs

**Exemple de commentaire** :

```markdown
## ✅ Tests Passed

- All unit tests passed: 127/127 ✅
- Coverage: 85%

**Test Results**:
- test_authentication.py: 45 tests ✅
- test_database.py: 52 tests ✅
- test_api.py: 30 tests ✅

---
*Generated by GitHub Actions*
```

#### Étape 6 : Mise à jour du statut de commit
```bash
github.rest.repos.createCommitStatus({
  state: 'success',
  description: 'All checks passed!',
  context: 'ci/tests'
})
```

### 3. **Résultat attendu**

#### Cas d'exécution réussie
```
✅ All checks passed!
- Format: OK (black)
- Lint: OK (pylint score: 9.2)
- Tests: 127/127 passed
- Coverage: 85%
- Build: ✅

Status → "Ready for Merge"
```

#### Cas d'échec
```
❌ Some checks failed

**Failing tests**:
- test_api.py::test_login FAILED (line 45)
  AssertionError: expected True, got False
- test_database.py::test_connection FAILED
  ConnectionError: cannot connect to localhost:5432

**Lint issues**:
- src/auth.py:12: Line too long (105 > 100)
- src/auth.py:23: Missing docstring

Status → "Blocked"
```

## 🔐 Permissions requises

| Permission | Raison |
|-----------|--------|
| `contents: read` | Lire le code |
| `pull-requests: write` | Commenter sur PRs |
| `statuses: write` | Écrire les commit status |

## ⚙️ Configuration

### Fichier de workflow
`.github/workflows/ci-tests.yml`

### Dépendances Python
```
pytest
pytest-cov
black
pylint
mypy
```

### Matrice de tests
```yaml
python-version: ["3.11"]
```

Peut être étendu à plusieurs versions (3.9, 3.10, 3.11, 3.12)

## 📊 Métriques capturées

| Métrique | Source | Utilisation |
|----------|--------|-------------|
| **Test Count** | JUnit XML | Tracking du progrès |
| **Pass/Fail Ratio** | pytest | Qualité globale |
| **Coverage %** | coverage.xml | Couverture de code |
| **Lint Score** | pylint | Qualité du code |
| **Build Status** | Build output | Compilabilité |

## 🔄 Intégration avec GitHub Project

Mapping des statuts :

| Test Status | Project Status |
|------------|----------------|
| ✅ Tous les tests passent | → "Ready for Merge" |
| ❌ Tests échouent | → "Blocked" |
| ⏳ Tests en cours | → "In QA" |

**Exemple GraphQL** (futur) :
```graphql
mutation UpdateProjectStatus {
  updateProjectV2ItemFieldValue(input: {
    projectId: "abc123"
    itemId: "def456"
    fieldId: "status"
    value: "Ready for Merge"
  }) {
    projectV2Item {
      id
    }
  }
}
```

## 💡 Cas d'usage

### Quand c'est utile
- ✅ Validation rapide avant review humain
- ✅ Feedback immédiat au développeur
- ✅ Tracking de coverage tendance
- ✅ Blocage automatique de PRs cassées

### Quand ce n'est pas suffisant
- ❌ Bugs complexes → tests manuels requis
- ❌ Tests d'intégration → infrastructure requise
- ❌ Tests e2e → setup Selenium/Playwright requis

## 🚨 Gestion des erreurs

### Erreur : "Module not found"
```
ImportError: No module named 'myapp'
```
**Solution** : Vérifier `requirements.txt` et l'import paths

### Erreur : "Database connection failed"
```
ConnectionError: cannot connect to localhost:5432
```
**Solution** : Utiliser un mock/in-memory DB pour CI (sqlite, h2)

### Erreur : "Coverage below threshold"
```
CoverageWarning: Coverage below 80%
```
**Solution** : Ajouter des tests ou baisser le threshold

## 📈 Évolution des métriques

Tracking dans le temps :

```bash
# Voir l'historique de coverage
git log --oneline | xargs -I {} sh -c 'git show {}:coverage.xml | grep coverage'

# Voir les trends de tests
gh run list --workflow ci-tests.yml
```

## 🔮 Améliorations futures

- [ ] Rapport détaillé de coverage par fichier
- [ ] Détection de regressions (score baisse)
- [ ] Intégration avec CodeCov pour tracking visuel
- [ ] Support de multiples langages (JS, Go, etc.)
- [ ] Fail sur security issues (bandit pour Python)
- [ ] Notification Slack/Discord sur failure
- [ ] Cache des dépendances pour faster runs
- [ ] Parallel test execution

## 📋 Checklist pour les mainteneurs

Avant de déployer :

- [ ] Tests locaux passent : `pytest tests/`
- [ ] Lint OK : `black --check . && pylint src/`
- [ ] Coverage > 80% : `pytest --cov=src/`
- [ ] Workflow YAML valide : `yamllint .github/workflows/`
- [ ] Tester sur une PR pilote
- [ ] Configurer les alertes (email, Slack)

## 📚 Ressources

- [Pytest Documentation](https://docs.pytest.org/)
- [Black Code Formatter](https://black.readthedocs.io/)
- [Pylint Documentation](https://pylint.pycqa.org/)
- [MyPy Documentation](https://mypy.readthedocs.io/)
